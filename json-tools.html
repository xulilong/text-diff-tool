<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONæ ¼å¼åŒ–å·¥å…· | Text Diff Tool</title>
    <meta name="description" content="å…è´¹çš„JSONæ ¼å¼åŒ–ã€å‹ç¼©ã€æ ‘ç»“æ„æŸ¥çœ‹å·¥å…·ï¼Œæ”¯æŒè½¬ä¹‰ã€å»è½¬ä¹‰å’Œå¤§æ•°æ®é‡å¤„ç†ã€‚">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f7fb;
            --bg-elevated: #ffffff;
            --bg-tertiary: #eef2f8;
            --text-primary: #1f2328;
            --text-secondary: #4c576a;
            --text-tertiary: #8a93a5;
            --accent-blue: #0969da;
            --accent-purple: #a371f7;
            --accent-green: #2da44e;
            --accent-yellow: #d29922;
            --border-default: #d0d7de;
            --radius-sm: 6px;
            --radius-md: 10px;
            --shadow-sm: 0 2px 8px rgba(15, 23, 42, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', 'PingFang SC', 'Microsoft Yahei', sans-serif;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-default);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .header-container {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .brand-text h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .brand-text p {
            margin: 0;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-nav .nav-link {
            padding: 6px 14px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            border: 1px solid transparent;
            transition: all 0.15s ease;
        }

        .header-nav .nav-link:hover {
            color: var(--text-primary);
            border-color: var(--border-default);
            background: var(--bg-secondary);
        }

        .header-nav .nav-link.active {
            background: var(--accent-blue);
            color: #fff;
            border-color: var(--accent-blue);
            box-shadow: 0 2px 6px rgba(9, 105, 218, 0.2);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-actions:empty {
            display: none;
        }

        .json-main {
            flex: 1;
            padding: clamp(24px, 4vw, 48px);
            width: min(96vw, 1800px);
            margin: 0 auto;
        }

        .json-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: clamp(16px, 2vw, 32px);
            align-items: start;
        }

        .json-column {
            display: flex;
            flex-direction: column;
            gap: clamp(16px, 2vw, 32px);
        }

        .json-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            margin: -24px -24px 0;
            border-bottom: 1px solid var(--border-default);
            background: var(--bg-tertiary);
            border-top-left-radius: var(--radius-md);
            border-top-right-radius: var(--radius-md);
            flex-wrap: nowrap;
        }

        .panel-header > div:first-child {
            flex-shrink: 1;
            min-width: 0;
        }

        .panel-header > div:last-child {
            flex-shrink: 0;
        }

        .panel-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-header p {
            margin: 0;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .action-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            margin: 0 -24px 16px;
            border-bottom: 1px solid var(--border-default);
            background: var(--bg-secondary);
        }

        .btn {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-default);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn:hover {
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .btn.primary {
            background: var(--accent-blue);
            color: #fff;
            border-color: var(--accent-blue);
            box-shadow: 0 4px 8px rgba(9, 105, 218, 0.2);
        }

        .btn.ghost {
            background: transparent;
        }

        textarea {
            width: 100%;
            min-height: 260px;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: #fafbfc;
            font-family: 'SF Mono', Monaco, 'Roboto Mono', Consolas, monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            white-space: pre;
        }

        textarea:focus {
            outline: none;
            background: #fff;
            box-shadow: none;
        }

        #jsonInput {
            min-height: 220px;
        }

        #jsonOutput {
            min-height: 200px;
        }

        .json-output {
            margin-top: 16px;
        }

        .json-status {
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .json-status.error {
            color: var(--accent-yellow);
        }

        .tree-container {
            flex: 1;
            min-height: 360px;
            background: #fafbfc;
            border: none;
            border-radius: 12px;
            padding: 12px;
            overflow: auto;
            font-family: 'SF Mono', Monaco, 'Roboto Mono', Consolas, monospace;
            font-size: 13px;
        }

        .tree-node {
            margin-bottom: 4px;
        }

        .tree-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 6px;
            border-radius: 6px;
            transition: background 0.15s ease;
        }

        .tree-label:hover {
            background: rgba(9, 105, 218, 0.08);
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid var(--border-default);
            background: var(--bg-primary);
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
        }

        .tree-key {
            font-weight: 600;
        }

        .tree-meta {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .tree-value {
            color: var(--accent-purple);
        }

        .tree-value.number {
            color: var(--accent-blue);
        }

        .tree-value.boolean {
            color: var(--accent-yellow);
        }

        .tree-value.null {
            color: var(--text-tertiary);
            font-style: italic;
        }

        .tree-children {
            margin-left: 24px;
            border-left: 1px dashed var(--border-default);
            padding-left: 12px;
        }

        .hidden {
            display: none;
        }

        .tree-search {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin: 12px 0;
        }

        .tree-search input {
            flex: 1;
            min-width: 180px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-default);
            background: var(--bg-primary);
            font-size: 12px;
        }

        .tree-search input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.18);
        }

        .tree-search .btn {
            flex: none;
        }

        .tree-search-result {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .tree-search-match {
            background: rgba(255, 196, 0, 0.25) !important;
        }

        .panel-tools {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
            flex-shrink: 0;
        }

        .tree-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: nowrap;
            flex-shrink: 0;
        }

        .tree-node {
            margin-bottom: 4px;
            position: relative;
        }

        .tree-node.dragging {
            opacity: 0.5;
        }

        .tree-node.drag-over {
            border-top: 2px solid var(--accent-blue);
            background: rgba(9, 105, 218, 0.05);
        }

        .tree-node.drag-over-bottom {
            border-bottom: 2px solid var(--accent-blue);
            background: rgba(9, 105, 218, 0.05);
        }

        .tree-node.selected {
            background: rgba(9, 105, 218, 0.1);
        }

        .tree-node.selected > .tree-label {
            background: rgba(9, 105, 218, 0.15);
        }


        .tree-label {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .tree-label.selectable {
            padding-left: 24px;
        }

        .tree-label.selectable .tree-dot {
            margin-left: 18px;
        }

        .tree-label.selectable .tree-toggle {
            margin-left: 18px;
        }

        .tree-label.selectable::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-default);
            border-radius: 3px;
            background: var(--bg-primary);
            transition: all 0.15s ease;
            z-index: 1;
        }

        .tree-node.selected > .tree-label.selectable::before {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .tree-node.selected > .tree-label.selectable::after {
            content: 'âœ“';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 2;
            pointer-events: none;
        }

        .tree-node-actions {
            display: inline-flex;
            gap: 4px;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .tree-label:hover .tree-node-actions {
            opacity: 1;
        }

        .tree-action-btn {
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s ease;
            font-weight: 500;
        }

        .tree-action-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .tree-action-btn.add {
            background: rgba(45, 164, 78, 0.1);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .tree-action-btn.add:hover {
            background: rgba(45, 164, 78, 0.2);
        }

        .tree-action-btn.delete {
            background: rgba(248, 81, 73, 0.1);
            border-color: #d1242f;
            color: #d1242f;
        }

        .tree-action-btn.delete:hover {
            background: rgba(248, 81, 73, 0.2);
        }

        .tree-node.draggable {
            cursor: grab;
        }

        .tree-node.draggable:active {
            cursor: grabbing;
        }

        .tree-node.draggable .tree-label {
            cursor: grab;
        }

        .tree-node.draggable .tree-label:active {
            cursor: grabbing;
        }

        .add-node-form {
            display: none;
            padding: 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-green);
            border-radius: var(--radius-sm);
            margin-top: 8px;
            margin-left: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .add-node-form.show {
            display: block;
        }

        .add-node-form .form-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .add-node-form .form-row {
            margin-bottom: 8px;
        }

        .add-node-form label {
            display: block;
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .add-node-form input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border-default);
            border-radius: 4px;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, monospace;
            background: var(--bg-primary);
        }

        .add-node-form input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(9, 105, 218, 0.1);
        }

        .add-node-form .form-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
            line-height: 1.4;
        }

        .add-node-form .form-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .tree-card {
            position: relative;
        }

        .tree-card.fullscreen {
            position: fixed;
            inset: 0;
            z-index: 4000;
            margin: 0;
            border-radius: 0;
            padding: clamp(16px, 3vw, 32px);
            background: var(--bg-primary);
        }

        .tree-card.fullscreen .tree-container {
            flex: 1;
            min-height: unset;
            height: calc(100vh - 220px);
        }

        .tree-card.fullscreen .tree-search {
            margin-top: 16px;
        }

        body.tree-fullscreen-active {
            overflow: hidden;
        }

        .stats-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 16px;
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
            flex-shrink: 0;
        }

        @media (max-width: 1024px) {
            .json-panels {
                grid-template-columns: 1fr;
            }

            .json-column {
                order: 2;
            }

            .tree-card {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .json-main {
                padding: 16px;
            }

            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .header-nav {
                width: 100%;
                overflow-x: auto;
            }

            textarea,
            .tree-container {
                min-height: 260px;
            }
        }

        /* Header Actions Buttons */
        .history-button,
        .share-button,
        .help-button {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .history-button:hover,
        .share-button:hover,
        .help-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        /* Share Modal */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2001;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .share-modal.show {
            display: flex;
        }

        .share-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 32px;
            max-width: 480px;
            width: 90%;
            box-shadow: var(--shadow-sm);
        }

        .share-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .share-header h2 {
            font-size: 20px;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .share-header p {
            font-size: 13px;
            color: var(--text-tertiary);
            margin: 0;
        }

        .share-options {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            justify-content: center;
        }

        .share-option {
            flex: 1;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .share-option:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 4px 12px rgba(9, 105, 218, 0.15);
        }

        .share-option .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .share-option .label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .share-url {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .share-url input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-family: monospace;
            background: var(--bg-secondary);
        }

        .share-url button {
            padding: 10px 20px;
            background: var(--accent-blue);
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .close-share {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .close-share:hover {
            background: var(--bg-elevated);
            border-color: var(--text-secondary);
        }

        /* Help Modal */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .help-modal.show {
            display: flex;
        }

        .help-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
            box-shadow: var(--shadow-sm);
        }

        .help-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-elevated);
        }

        .help-header h2 {
            font-size: 20px;
            margin: 0;
        }

        .close-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .close-button:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .help-body {
            padding: 24px;
        }

        .help-section {
            margin-bottom: 24px;
        }

        .help-section h3 {
            font-size: 16px;
            margin: 0 0 12px 0;
            color: var(--text-primary);
        }

        .help-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .help-section li {
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
        }

        /* History Drawer */
        .history-drawer {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: var(--bg-elevated);
            border-left: 1px solid var(--border-default);
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
            z-index: 2001;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .history-drawer.show {
            right: 0;
        }

        .history-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            backdrop-filter: blur(3px);
            transition: opacity 0.3s ease;
        }

        .history-overlay.show {
            display: block;
        }

        .history-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-default);
            background: var(--bg-secondary);
        }

        .history-header h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .history-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .history-actions button {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 500;
        }

        .history-actions button:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .history-item:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 4px 12px rgba(9, 105, 218, 0.15);
            transform: translateY(-2px);
        }

        .history-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .history-item-number {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-blue);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(9, 105, 218, 0.1);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(9, 105, 218, 0.2);
        }

        .history-item-time {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
            flex: 1;
        }

        .history-item-delete {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-tertiary);
            font-size: 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
            font-weight: 500;
        }

        .history-item-delete:hover {
            background: rgba(248, 81, 73, 0.1);
            border-color: rgba(248, 81, 73, 0.3);
            color: #d1242f;
        }

        .history-item-preview {
            margin-bottom: 10px;
        }

        .history-item-label {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .history-item-text {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: var(--bg-tertiary);
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-default);
            line-height: 1.4;
        }

        .history-item-meta {
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-tertiary);
            padding-top: 8px;
            border-top: 1px solid var(--border-default);
        }

        .history-empty {
            text-align: center;
            padding: 80px 32px;
            color: var(--text-tertiary);
        }

        .history-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .history-empty-text {
            font-size: 14px;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .history-drawer {
                width: 100%;
                right: -100%;
            }

            .history-button span:last-child,
            .share-button span:last-child,
            .help-button span:last-child {
                display: none;
            }
        }
    </style>
</head>
<body data-page="json" data-header-actions="json">
    <div class="app-container">
        <div data-include="partials/header.html"></div>

        <main class="json-main">
            <div class="json-panels">
                <div class="json-column">
                    <section class="json-card">
                        <div class="panel-header">
                            <div>
                                <h2>JSON è¾“å…¥</h2>
                                <p>æ”¯æŒç²˜è´´ã€æ‹–æ‹½å’Œè½½å…¥æ–‡ä»¶</p>
                            </div>
                            <div class="stats-row" id="inputStats">0å­—ç¬¦ Â· 0è¡Œ</div>
                        </div>
                        <div class="action-row">
                            <button class="btn primary" id="formatBtn">âœ¨ æ ¼å¼åŒ–</button>
                            <button class="btn" id="compressBtn">ğŸ“¦ å‹ç¼©</button>
                            <button class="btn" id="escapeBtn">ğŸ” è½¬ä¹‰</button>
                            <button class="btn" id="unescapeBtn">ğŸ”“ å»è½¬ä¹‰</button>
                            <button class="btn" id="loadSampleBtn">ğŸ“‹ ç¤ºä¾‹</button>
                            <button class="btn ghost" id="loadFileBtn">ğŸ“‚ å¯¼å…¥æ–‡ä»¶</button>
                            <button class="btn ghost" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©º</button>
                        </div>
                        <textarea id="jsonInput" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´ JSON..."></textarea>
                        <input type="file" id="fileInput" accept=".json,.txt,.log" style="display: none;">
                        <div class="json-status" id="inputStatus">ç­‰å¾…è¾“å…¥...</div>
                    </section>

                    <section class="json-card">
                        <div class="panel-header">
                            <div>
                                <h2>æ ¼å¼åŒ–ç»“æœ</h2>
                                <p>å¯å¤åˆ¶ã€ä¸‹è½½ä»¥åŠæ ‘å½¢æŸ¥çœ‹</p>
                            </div>
                            <div class="panel-actions">
                                <button class="btn" id="copyOutputBtn">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
                            </div>
                        </div>
                        <textarea id="jsonOutput" class="json-output" placeholder="æ ¼å¼åŒ–ç»“æœå°†åœ¨æ­¤å±•ç¤º" readonly></textarea>
                    </section>
                </div>

                <section class="json-card tree-card" id="treePanel">
                    <div class="panel-header">
                        <div>
                            <h2>æ ‘å½¢ç»“æ„</h2>
                            <p>èŠ‚ç‚¹æŒ‰éœ€å±•å¼€ï¼Œé¿å…å¤§æ•°æ®å¡é¡¿</p>
                        </div>
                        <div class="panel-tools">
                            <div class="stats-row" id="treeStats">æœªè§£æ</div>
                            <div class="tree-actions">
                                <button class="btn ghost" id="treeExpandAllBtn" type="button" title="å…¨éƒ¨å±•å¼€">ğŸ“‚ å±•å¼€</button>
                                <button class="btn ghost" id="treeCollapseAllBtn" type="button" title="å…¨éƒ¨æ”¶èµ·">ğŸ“ æ”¶èµ·</button>
                                <button class="btn ghost" id="treeSelectModeBtn" type="button" title="åˆ‡æ¢é€‰æ‹©æ¨¡å¼">âœ“ é€‰æ‹©æ¨¡å¼</button>
                                <button class="btn ghost" id="treeCopySelectedBtn" type="button" title="å¤åˆ¶é€‰ä¸­èŠ‚ç‚¹" disabled>ğŸ“‹ å¤åˆ¶é€‰ä¸­</button>
                                <button class="btn ghost" id="treeCopyAllBtn" type="button" title="å¤åˆ¶å…¨éƒ¨èŠ‚ç‚¹">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button>
                                <button class="btn ghost" id="treeFullscreenBtn" type="button" title="å…¨å±æŸ¥çœ‹æ ‘ç»“æ„">â›¶ å…¨å±</button>
                            </div>
                        </div>
                    </div>
                    <div class="tree-search">
                        <input type="text" id="treeSearchInput" placeholder="æœç´¢å­—æ®µæˆ–å€¼...">
                        <button class="btn" id="treeSearchBtn">ğŸ” æœç´¢</button>
                        <button class="btn ghost" id="treePrevBtn">â¬† ä¸Šä¸€ä¸ª</button>
                        <button class="btn ghost" id="treeNextBtn">â¬‡ ä¸‹ä¸€ä¸ª</button>
                        <span class="tree-search-result" id="treeSearchResult">æœªæœç´¢</span>
                    </div>
                    <div class="tree-container" id="jsonTree">
                        <p style="color: var(--text-tertiary);">è§£æåå°†åœ¨æ­¤å±•ç¤ºä¸ºæ ‘å½¢ç»“æ„</p>
                    </div>
                </section>
            </div>
        </main>
        
        <div data-include="partials/footer.html"></div>
    </div>

    <!-- History Drawer -->
    <div class="history-overlay" id="historyOverlay" onclick="toggleHistory()"></div>
    <div class="history-drawer" id="historyDrawer">
        <div class="history-header">
            <h3>
                <span>ğŸ“œ</span>
                <span>å†å²è®°å½•</span>
            </h3>
            <div class="history-actions">
                <button onclick="clearHistory()" title="æ¸…ç©ºæ‰€æœ‰">ğŸ—‘ï¸ æ¸…ç©º</button>
                <button onclick="toggleHistory()" title="å…³é—­">Ã—</button>
            </div>
        </div>
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="shareModal" onclick="if(event.target===this) toggleShare()">
        <div class="share-content">
            <div class="share-header">
                <h2>
                    <span>ğŸ”—</span>
                    <span>åˆ†äº«å·¥å…·</span>
                </h2>
                <p>å¸®åŠ©æ›´å¤šäººå‘ç°è¿™ä¸ªå¥½ç”¨çš„å·¥å…·</p>
            </div>

            <div class="share-options">
                <div class="share-option" onclick="shareToWeChat()">
                    <div class="icon">ğŸ’¬</div>
                    <div class="label">å¾®ä¿¡åˆ†äº«</div>
                </div>
                <div class="share-option" onclick="shareToWeibo()">
                    <div class="icon">ğŸ”µ</div>
                    <div class="label">å¾®åšåˆ†äº«</div>
                </div>
            </div>

            <div id="wechatShareContent" style="display: none;">
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: var(--radius-md); margin-bottom: 16px;">
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px;">åˆ†äº«æ–‡æ¡ˆï¼š</div>
                        <div style="background: var(--bg-elevated); padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--border-default); position: relative;">
                            <p id="shareText" style="font-size: 13px; color: var(--text-primary); line-height: 1.6; margin: 0;">å‘ç°ä¸€ä¸ªè¶…å¥½ç”¨çš„JSONæ ¼å¼åŒ–å·¥å…·ï¼âœ¨ æ”¯æŒæ ¼å¼åŒ–ã€å‹ç¼©ã€è½¬ä¹‰ã€æ ‘ç»“æ„æŸ¥çœ‹ï¼Œå®Œå…¨å…è´¹ä½¿ç”¨ï¼å¼€å‘è€…å¿…å¤‡ç¥å™¨ ğŸš€

https://json.asia/json-tools.html</p>
                            <button onclick="copyShareText()" style="position: absolute; top: 8px; right: 8px; padding: 4px 12px; background: var(--accent-blue); color: #fff; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">å¤åˆ¶</button>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px;">é“¾æ¥ï¼š</div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="shareUrlWechat" readonly value="" style="flex: 1; padding: 8px 12px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary); font-family: monospace;">
                            <button onclick="copyWechatUrl()" style="padding: 8px 16px; background: var(--accent-green); color: #fff; border: none; border-radius: var(--radius-sm); font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">å¤åˆ¶é“¾æ¥</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; font-size: 12px; color: var(--text-tertiary);">
                    ğŸ“± å¤åˆ¶ååœ¨å¾®ä¿¡ä¸­ç²˜è´´åˆ†äº«ç»™å¥½å‹
                </div>
            </div>

            <div class="share-url" id="shareUrlSection">
                <input type="text" id="shareUrl" readonly value="" placeholder="å·¥å…·é“¾æ¥">
                <button onclick="copyShareUrl()">å¤åˆ¶é“¾æ¥</button>
            </div>

            <button class="close-share" onclick="toggleShare()">å…³é—­</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="help-modal" id="helpModal" onclick="if(event.target===this) toggleHelp()">
        <div class="help-content">
            <div class="help-header">
                <h2>ğŸ’¡ ä½¿ç”¨å¸®åŠ©</h2>
                <button class="close-button" onclick="toggleHelp()">Ã—</button>
            </div>
            <div class="help-body">
                <div class="help-section">
                    <h3>ğŸ¯ æ ¸å¿ƒåŠŸèƒ½</h3>
                    <ul>
                        <li>âœ… JSONæ ¼å¼åŒ–ï¼šç¾åŒ–JSONä»£ç ï¼Œæé«˜å¯è¯»æ€§</li>
                        <li>âœ… JSONå‹ç¼©ï¼šå»é™¤ç©ºæ ¼å’Œæ¢è¡Œï¼Œå‡å°æ–‡ä»¶å¤§å°</li>
                        <li>âœ… è½¬ä¹‰/å»è½¬ä¹‰ï¼šå¤„ç†JSONå­—ç¬¦ä¸²è½¬ä¹‰</li>
                        <li>âœ… æ ‘å½¢ç»“æ„ï¼šå¯è§†åŒ–æŸ¥çœ‹JSONç»“æ„ï¼Œæ”¯æŒæœç´¢</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>âš¡ å¿«æ·é”®</h3>
                    <ul>
                        <li><span class="kbd">Esc</span> - å…³é—­å¸®åŠ©/å…¨å±</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ“‹ ä½¿ç”¨æ­¥éª¤</h3>
                    <ul>
                        <li><strong>1.</strong> è¾“å…¥æˆ–ç²˜è´´JSONåˆ°è¾“å…¥æ¡†</li>
                        <li><strong>2.</strong> ç‚¹å‡»"æ ¼å¼åŒ–"ç¾åŒ–ä»£ç </li>
                        <li><strong>3.</strong> æŸ¥çœ‹æ ¼å¼åŒ–ç»“æœå’Œæ ‘å½¢ç»“æ„</li>
                        <li><strong>4.</strong> ä½¿ç”¨æœç´¢åŠŸèƒ½å¿«é€Ÿå®šä½å­—æ®µ</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ’¡ ä½¿ç”¨æŠ€å·§</h3>
                    <ul>
                        <li>æ”¯æŒæ‹–æ‹½æ–‡ä»¶åŠ è½½JSON</li>
                        <li>æ ‘å½¢ç»“æ„æŒ‰éœ€å±•å¼€ï¼Œé¿å…å¤§æ•°æ®å¡é¡¿</li>
                        <li>æ”¯æŒå…³é”®è¯æœç´¢ï¼Œå¿«é€Ÿå®šä½æ•°æ®</li>
                        <li>å®Œå…¨å…è´¹ä½¿ç”¨ï¼Œæ— éœ€æ³¨å†Œç™»å½•</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="include-partials.js"></script>
    <script>
        const jsonInput = document.getElementById('jsonInput');
        const jsonOutput = document.getElementById('jsonOutput');
        const jsonTree = document.getElementById('jsonTree');
        const inputStatus = document.getElementById('inputStatus');
        const inputStats = document.getElementById('inputStats');
        const treeStats = document.getElementById('treeStats');
        const fileInput = document.getElementById('fileInput');
        const treeSearchInput = document.getElementById('treeSearchInput');
        const treeSearchResult = document.getElementById('treeSearchResult');
        const treeFullscreenBtn = document.getElementById('treeFullscreenBtn');
        const treePanel = document.getElementById('treePanel');

        let treeSearchMatches = [];
        let treeSearchIndex = -1;
        let treeNodeRegistry = new Map();
        let currentJsonData = null;
        let selectMode = false; // é€‰æ‹©æ¨¡å¼å¼€å…³
        let selectedNodes = new Set(); // é€‰ä¸­çš„èŠ‚ç‚¹è·¯å¾„é›†åˆ

        document.getElementById('formatBtn').addEventListener('click', () => formatJson('pretty'));
        document.getElementById('compressBtn').addEventListener('click', () => formatJson('minify'));
        document.getElementById('escapeBtn').addEventListener('click', escapeJson);
        document.getElementById('unescapeBtn').addEventListener('click', unescapeJson);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('copyOutputBtn').addEventListener('click', copyOutput);
        document.getElementById('loadSampleBtn').addEventListener('click', loadSample);
        document.getElementById('loadFileBtn').addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        jsonInput.addEventListener('input', updateStats);
        document.getElementById('treeSearchBtn').addEventListener('click', searchTree);
        document.getElementById('treePrevBtn').addEventListener('click', () => navigateTreeMatch(-1));
        document.getElementById('treeNextBtn').addEventListener('click', () => navigateTreeMatch(1));
        treeSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                searchTree();
            }
        });
        if (treeFullscreenBtn) {
            treeFullscreenBtn.addEventListener('click', toggleTreeFullscreen);
        }
        document.getElementById('treeExpandAllBtn').addEventListener('click', expandAllNodes);
        document.getElementById('treeCollapseAllBtn').addEventListener('click', collapseAllNodes);
        document.getElementById('treeSelectModeBtn').addEventListener('click', toggleSelectMode);
        document.getElementById('treeCopySelectedBtn').addEventListener('click', copySelectedNodes);
        document.getElementById('treeCopyAllBtn').addEventListener('click', copyAllNodes);

        updateStats();

        function updateStats() {
            const text = jsonInput.value;
            const lines = text.split(/\n/).length;
            inputStats.textContent = `${text.length}å­—ç¬¦ Â· ${lines}è¡Œ`;
        }

        function formatJson(mode) {
            const text = jsonInput.value.trim();
            if (!text) {
                showStatus('è¯·è¾“å…¥JSON', 'error');
                return;
            }
            try {
                const parsed = JSON.parse(text);
                currentJsonData = parsed;
                const formatted = mode === 'minify' ? JSON.stringify(parsed) : JSON.stringify(parsed, null, 2);
                jsonOutput.value = formatted;
                showStatus(mode === 'minify' ? 'å‹ç¼©æˆåŠŸ' : 'æ ¼å¼åŒ–æˆåŠŸ');
                treeStats.textContent = `æ ¹ç±»å‹ï¼š${getTypeLabel(parsed)}`;
                renderTree(parsed);
                // ä¿å­˜åˆ°å†å²è®°å½•
                saveToHistory(text);
            } catch (err) {
                showStatus('è§£æå¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        function escapeJson() {
            const escaped = JSON.stringify(jsonInput.value);
            jsonOutput.value = escaped.slice(1, escaped.length - 1);
            showStatus('å·²è½¬ä¹‰ JSON å­—ç¬¦ä¸²');
        }

        function unescapeJson() {
            const text = jsonInput.value;
            try {
                const unescaped = JSON.parse('"' + text.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '"');
                jsonOutput.value = unescaped;
                showStatus('å·²è¿˜åŸè½¬ä¹‰å­—ç¬¦ä¸²');
            } catch (err) {
                showStatus('è¿˜åŸå¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        function clearAll() {
            jsonInput.value = '';
            jsonOutput.value = '';
            jsonTree.innerHTML = '<p style="color: var(--text-tertiary);">è§£æåå°†åœ¨æ­¤å±•ç¤ºä¸ºæ ‘å½¢ç»“æ„</p>';
            treeStats.textContent = 'æœªè§£æ';
            showStatus('å·²æ¸…ç©º');
            updateStats();
            currentJsonData = null;
            treeNodeRegistry = new Map();
            resetTreeSearchState();
        }

        function copyOutput() {
            if (!jsonOutput.value) {
                showStatus('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'error');
                return;
            }
            const btn = document.getElementById('copyOutputBtn');
            const originalText = btn.textContent;
            
            navigator.clipboard.writeText(jsonOutput.value).then(() => {
                btn.textContent = 'âœ“ å·²å¤åˆ¶';
                btn.style.background = 'var(--accent-green)';
                btn.style.color = '#fff';
                showStatus('JSONæ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç›´æ¥ç²˜è´´ä½¿ç”¨');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }).catch(() => {
                // å¤‡ç”¨æ–¹æ³•
                try {
                    jsonOutput.select();
                    document.execCommand('copy');
                    btn.textContent = 'âœ“ å·²å¤åˆ¶';
                    btn.style.background = 'var(--accent-green)';
                    btn.style.color = '#fff';
                    showStatus('JSONæ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.style.color = '';
                    }, 2000);
                } catch (err) {
                    showStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
                }
            });
        }

        function loadSample() {
            const sample = {
                name: 'Text Diff Tool',
                version: '3.0',
                features: ['æ ¼å¼åŒ–', 'å‹ç¼©', 'è½¬ä¹‰', 'æ ‘ç»“æ„'],
                stats: {
                    users: 12830,
                    likes: 5234
                },
                meta: {
                    createdAt: new Date().toISOString(),
                    author: 'json.asia'
                }
            };
            jsonInput.value = JSON.stringify(sample, null, 2);
            updateStats();
            formatJson('pretty');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                jsonInput.value = e.target.result;
                updateStats();
                showStatus('å·²è½½å…¥æ–‡ä»¶ï¼š' + file.name);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function showStatus(message, type) {
            inputStatus.textContent = message;
            if (type === 'error') {
                inputStatus.classList.add('error');
            } else {
                inputStatus.classList.remove('error');
            }
        }

        function renderTree(value) {
            jsonTree.innerHTML = '';
            treeNodeRegistry = new Map();
            const rootNode = createTreeNode('root', value, 0, 'root', null, null);
            jsonTree.appendChild(rootNode);
            resetTreeSearchState();
        }

        function createTreeNode(key, value, depth, path, parentValue = null, parentPath = null) {
            const node = document.createElement('div');
            node.className = 'tree-node';
            
            const label = document.createElement('div');
            label.className = 'tree-label';
            label.style.paddingLeft = depth * 14 + 'px';
            label.dataset.path = path;

            // æ·»åŠ é€‰æ‹©åŠŸèƒ½ï¼ˆéæ ¹èŠ‚ç‚¹ï¼‰
            if (parentValue !== null) {
                // å¦‚æœé€‰æ‹©æ¨¡å¼å¼€å¯ï¼Œæ·»åŠ selectableç±»å’Œäº‹ä»¶ç›‘å¬å™¨
                if (selectMode) {
                    label.classList.add('selectable');
                label.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–æ“ä½œåŒºåŸŸï¼Œä¸è§¦å‘é€‰æ‹©
                    if (e.target.closest('.tree-toggle, .tree-node-actions, .tree-action-btn')) {
                        return;
                    }
                    if (selectMode) {
                        toggleNodeSelection(path);
                    }
                });
                    label.setAttribute('data-selection-listener', 'true');
                }
            }

            const registryEntry = { value, label, depth, toggle: null, container: null, node, key, parentValue, parentPath };

            // æ“ä½œæŒ‰é’®å®¹å™¨
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'tree-node-actions';

            if (isExpandable(value)) {
                const toggle = document.createElement('button');
                toggle.className = 'tree-toggle';
                toggle.textContent = '+';
                toggle.setAttribute('data-expanded', 'false');
                const meta = document.createElement('span');
                meta.className = 'tree-meta';
                const childCount = Array.isArray(value) ? value.length : Object.keys(value).length;
                meta.textContent = `${childCount}é¡¹`;

                const keySpan = document.createElement('span');
                keySpan.className = 'tree-key';
                keySpan.textContent = key;

                // æ·»åŠ èŠ‚ç‚¹æŒ‰é’®
                const addBtn = document.createElement('button');
                addBtn.className = 'tree-action-btn add';
                addBtn.textContent = '+ æ·»åŠ ';
                addBtn.title = 'æ·»åŠ å­èŠ‚ç‚¹';
                addBtn.onclick = (e) => {
                    e.stopPropagation();
                    showAddNodeForm(node, value, path);
                };

                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'tree-action-btn delete';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.title = 'åˆ é™¤èŠ‚ç‚¹';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteNode(path, parentValue, parentPath, key);
                };

                actionsContainer.appendChild(addBtn);
                if (parentValue !== null) {
                    actionsContainer.appendChild(deleteBtn);
                }

                label.appendChild(toggle);
                label.appendChild(keySpan);
                label.appendChild(meta);
                label.appendChild(actionsContainer);
                node.appendChild(label);

                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children hidden';
                childrenContainer.dataset.path = path;
                childrenContainer.dataset.parentValue = 'object';
                node.appendChild(childrenContainer);

                // ä¸ºå®¹å™¨æ·»åŠ æ‹–æ‹½æ”¯æŒ
                childrenContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    e.dataTransfer.dropEffect = 'move';
                    const draggingNode = document.querySelector('.dragging');
                    if (draggingNode) {
                        const dragPath = draggingNode.dataset.path;
                        if (dragPath && dragPath !== path && !path.startsWith(dragPath + '/')) {
                            childrenContainer.style.backgroundColor = 'rgba(9, 105, 218, 0.1)';
                            childrenContainer.style.border = '2px dashed var(--accent-blue)';
                        }
                    }
                });

                childrenContainer.addEventListener('dragleave', (e) => {
                    // åªæœ‰å½“é¼ æ ‡çœŸæ­£ç¦»å¼€å®¹å™¨æ—¶æ‰æ¸…é™¤æ ·å¼
                    if (!childrenContainer.contains(e.relatedTarget)) {
                        childrenContainer.style.backgroundColor = '';
                        childrenContainer.style.border = '';
                    }
                });

                childrenContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    childrenContainer.style.backgroundColor = '';
                    childrenContainer.style.border = '';
                    
                    try {
                        const dragDataStr = e.dataTransfer.getData('text/plain');
                        if (!dragDataStr) return;
                        
                        const dragData = JSON.parse(dragDataStr);
                        if (!dragData || dragData.path === path) return;
                        
                        if (path.startsWith(dragData.path + '/')) {
                            showStatus('ä¸èƒ½å°†èŠ‚ç‚¹æ‹–åˆ°è‡ªå·±å†…éƒ¨', 'error');
                            return;
                        }
                        
                        // ç¡®ä¿ç›®æ ‡èŠ‚ç‚¹å·²å±•å¼€
                        const toggle = node.querySelector('.tree-toggle');
                        if (toggle && toggle.getAttribute('data-expanded') === 'false') {
                            toggle.click();
                        }
                        
                        moveNodeToTarget(dragData, path, value, path, parentValue, parentPath, 'inside');
                    } catch (err) {
                        console.error('æ‹–æ‹½å¤±è´¥:', err);
                        showStatus('æ‹–æ‹½å¤±è´¥ï¼š' + err.message, 'error');
                    }
                });

                registryEntry.toggle = toggle;
                registryEntry.container = childrenContainer;

                toggle.addEventListener('click', () => {
                    const expanded = toggle.getAttribute('data-expanded') === 'true';
                    if (!expanded && childrenContainer.dataset.loaded !== 'true') {
                        renderChildren(childrenContainer, value, depth + 1, path);
                    }
                    toggle.setAttribute('data-expanded', String(!expanded));
                    toggle.textContent = expanded ? '+' : '-';
                    childrenContainer.classList.toggle('hidden');
                });
            } else {
                const keySpan = document.createElement('span');
                keySpan.className = 'tree-key';
                keySpan.textContent = key;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'tree-value ' + typeof value;
                valueSpan.textContent = formatPrimitive(value);

                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'tree-action-btn delete';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.title = 'åˆ é™¤èŠ‚ç‚¹';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteNode(path, parentValue, parentPath, key);
                };

                if (parentValue !== null) {
                    actionsContainer.appendChild(deleteBtn);
                }

                const dotSpan = document.createElement('span');
                dotSpan.className = 'tree-dot';
                dotSpan.textContent = 'â€¢';
                label.appendChild(dotSpan);
                label.appendChild(keySpan);
                label.appendChild(valueSpan);
                label.appendChild(actionsContainer);
                node.appendChild(label);
            }

            // æ‹–æ‹½åŠŸèƒ½ - æ‰€æœ‰éæ ¹èŠ‚ç‚¹éƒ½å¯ä»¥æ‹–åŠ¨
            if (parentValue !== null) {
                node.classList.add('draggable');
                node.draggable = true;
                node.dataset.path = path;
                node.dataset.parentPath = parentPath || '';
                node.dataset.key = key;

                node.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    // æ·±æ‹·è´èŠ‚ç‚¹å€¼ï¼Œé¿å…å¼•ç”¨é—®é¢˜
                    const clonedValue = JSON.parse(JSON.stringify(value));
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        path: path,
                        key: key,
                        parentPath: parentPath,
                        value: clonedValue
                    }));
                    node.classList.add('dragging');
                });

                node.addEventListener('dragend', () => {
                    node.classList.remove('dragging');
                    document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
                        el.classList.remove('drag-over', 'drag-over-bottom');
                    });
                });

                // å…è®¸æ‹–æ‹½åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Š
                node.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const draggingNode = document.querySelector('.dragging');
                    if (!draggingNode || draggingNode === node || node.contains(draggingNode)) {
                        return;
                    }
                    
                    // è·å–æ‹–æ‹½èŠ‚ç‚¹çš„è·¯å¾„ï¼ˆä» draggingNode çš„ dataset è·å–ï¼‰
                    const dragPath = draggingNode.dataset.path;
                    if (!dragPath || dragPath === path || path.startsWith(dragPath + '/')) {
                        return;
                    }
                    
                    const rect = node.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    const isTopHalf = e.clientY < midY;
                    
                    // å¦‚æœç›®æ ‡èŠ‚ç‚¹æ˜¯å¯å±•å¼€çš„ï¼Œä¸ŠåŠéƒ¨åˆ†è¡¨ç¤ºæ’å…¥åˆ°å†…éƒ¨ï¼Œä¸‹åŠéƒ¨åˆ†è¡¨ç¤ºæ’å…¥åˆ°æ—è¾¹
                    if (isExpandable(value)) {
                        if (isTopHalf) {
                            node.classList.remove('drag-over-bottom');
                            node.classList.add('drag-over');
                            node.dataset.dropMode = 'inside';
                        } else {
                            node.classList.remove('drag-over');
                            node.classList.add('drag-over-bottom');
                            node.dataset.dropMode = 'after';
                        }
                    } else {
                        // å¶å­èŠ‚ç‚¹ï¼Œåªèƒ½æ’å…¥åˆ°æ—è¾¹
                        node.classList.remove('drag-over');
                        node.classList.add('drag-over-bottom');
                        node.dataset.dropMode = 'after';
                    }
                });

                node.addEventListener('dragleave', () => {
                    node.classList.remove('drag-over', 'drag-over-bottom');
                    delete node.dataset.dropMode;
                });

                node.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const dropMode = node.dataset.dropMode || 'inside';
                    node.classList.remove('drag-over', 'drag-over-bottom');
                    delete node.dataset.dropMode;
                    
                    try {
                        const dragDataStr = e.dataTransfer.getData('text/plain');
                        if (!dragDataStr) return;
                        
                        const dragData = JSON.parse(dragDataStr);
                        if (!dragData || dragData.path === path) return;
                        
                        // æ£€æŸ¥æ˜¯å¦è¯•å›¾æ‹–åˆ°è‡ªå·±å†…éƒ¨
                        if (path.startsWith(dragData.path + '/')) {
                            showStatus('ä¸èƒ½å°†èŠ‚ç‚¹æ‹–åˆ°è‡ªå·±å†…éƒ¨', 'error');
                            return;
                        }
                        
                        moveNodeToTarget(dragData, path, value, path, parentValue, parentPath, dropMode);
                    } catch (err) {
                        console.error('æ‹–æ‹½å¤±è´¥:', err);
                        showStatus('æ‹–æ‹½å¤±è´¥ï¼š' + err.message, 'error');
                    }
                });
            }

            treeNodeRegistry.set(path, registryEntry);
            return node;
        }

        function renderChildren(container, value, depth, parentPath, parentValue = null) {
            if (container.dataset.loaded === 'true') return;
            container.dataset.abort = 'false';
            const entries = Array.isArray(value)
                ? value.map((v, i) => [i, v])
                : Object.entries(value);
            let index = 0;

            const schedule = window.requestIdleCallback
                ? (cb) => requestIdleCallback(cb)
                : (cb) => setTimeout(() => cb({ timeRemaining: () => 0 }), 0);

            function process(deadline) {
                if (container.dataset.abort === 'true' || container.dataset.loaded === 'true') {
                    return;
                }
                const fragment = document.createDocumentFragment();
                while (index < entries.length && (deadline.timeRemaining ? deadline.timeRemaining() > 0 : fragment.childNodes.length < 200)) {
                    const [childKey, childVal] = entries[index++];
                    const childPath = buildChildPath(parentPath, childKey);
                    fragment.appendChild(createTreeNode(childKey, childVal, depth, childPath, value, parentPath));
                }
                container.appendChild(fragment);
                if (index < entries.length) {
                    schedule(process);
                } else {
                    container.dataset.loaded = 'true';
                    container.dataset.abort = 'false';
                }
            }

            schedule(process);
        }

        function renderChildrenImmediate(container, value, depth, parentPath, parentValue = null) {
            if (container.dataset.loaded === 'true') return;
            const fragment = document.createDocumentFragment();
            const entries = Array.isArray(value)
                ? value.map((v, i) => [i, v])
                : Object.entries(value);
            entries.forEach(([childKey, childVal]) => {
                const childPath = buildChildPath(parentPath, childKey);
                fragment.appendChild(createTreeNode(childKey, childVal, depth, childPath, value, parentPath));
            });
            container.appendChild(fragment);
            container.dataset.loaded = 'true';
            container.dataset.abort = 'true';
        }

        function isExpandable(value) {
            return value && typeof value === 'object';
        }

        function getTypeLabel(value) {
            if (Array.isArray(value)) return 'æ•°ç»„';
            if (value === null) return 'null';
            return typeof value;
        }

        function formatPrimitive(value) {
            if (typeof value === 'string') return '"' + value + '"';
            if (value === null) return 'null';
            return String(value);
        }

        function buildChildPath(parentPath, segment) {
            return `${parentPath}/${encodePathSegment(segment)}`;
        }

        function encodePathSegment(segment) {
            return String(segment).replace(/~/g, '~0').replace(/\//g, '~1');
        }

        function resetTreeSearchState() {
            treeSearchMatches = [];
            treeSearchIndex = -1;
            treeSearchResult.textContent = 'æœªæœç´¢';
            jsonTree.querySelectorAll('.tree-search-match').forEach(el => el.classList.remove('tree-search-match'));
        }

        // ==================== æ ‘å½¢ç»“æ„æ“ä½œåŠŸèƒ½ ====================

        // å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
        function expandAllNodes() {
            const allToggles = jsonTree.querySelectorAll('.tree-toggle[data-expanded="false"]');
            allToggles.forEach(toggle => {
                const node = toggle.closest('.tree-node');
                const container = node.querySelector('.tree-children');
                if (container && container.dataset.loaded !== 'true') {
                    const path = node.querySelector('.tree-label')?.dataset.path;
                    if (path) {
                        const entry = treeNodeRegistry.get(path);
                        if (entry && entry.value && isExpandable(entry.value)) {
                            renderChildrenImmediate(container, entry.value, entry.depth + 1, path, entry.value);
                        }
                    }
                }
                toggle.setAttribute('data-expanded', 'true');
                toggle.textContent = '-';
                if (container) container.classList.remove('hidden');
            });
        }

        // æ”¶èµ·æ‰€æœ‰èŠ‚ç‚¹
        function collapseAllNodes() {
            const allToggles = jsonTree.querySelectorAll('.tree-toggle[data-expanded="true"]');
            allToggles.forEach(toggle => {
                toggle.setAttribute('data-expanded', 'false');
                toggle.textContent = '+';
                const container = toggle.closest('.tree-node').querySelector('.tree-children');
                if (container) container.classList.add('hidden');
            });
        }

        // åˆ é™¤èŠ‚ç‚¹
        function deleteNode(path, parentValue, parentPath, key) {
            if (!confirm(`ç¡®å®šåˆ é™¤èŠ‚ç‚¹ "${key}" å—ï¼Ÿ`)) return;

            try {
                if (Array.isArray(parentValue)) {
                    const index = parseInt(key);
                    parentValue.splice(index, 1);
                } else if (typeof parentValue === 'object' && parentValue !== null) {
                    delete parentValue[key];
                }

                // æ›´æ–° JSON æ•°æ®
                updateJsonFromTree();
                showStatus('èŠ‚ç‚¹å·²åˆ é™¤');
            } catch (err) {
                showStatus('åˆ é™¤å¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ·»åŠ èŠ‚ç‚¹è¡¨å•
        function showAddNodeForm(node, parentValue, parentPath) {
            // ç§»é™¤å·²å­˜åœ¨çš„è¡¨å•
            const existingForm = jsonTree.querySelector('.add-node-form');
            if (existingForm) {
                existingForm.remove();
            }

            const form = document.createElement('div');
            form.className = 'add-node-form show';
            
            const title = document.createElement('div');
            title.className = 'form-title';
            title.innerHTML = '<span>â•</span><span>æ·»åŠ æ–°èŠ‚ç‚¹</span>';
            
            const keyRow = document.createElement('div');
            keyRow.className = 'form-row';
            const keyLabel = document.createElement('label');
            keyLabel.textContent = Array.isArray(parentValue) ? 'æ•°ç»„ç´¢å¼•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰' : 'é”®å (Key)';
            const keyInput = document.createElement('input');
            keyInput.type = 'text';
            keyInput.placeholder = Array.isArray(parentValue) ? 'è‡ªåŠ¨åˆ†é…ç´¢å¼•' : 'ä¾‹å¦‚: name, age, status';
            keyInput.disabled = Array.isArray(parentValue);
            keyRow.appendChild(keyLabel);
            keyRow.appendChild(keyInput);
            
            const valueRow = document.createElement('div');
            valueRow.className = 'form-row';
            const valueLabel = document.createElement('label');
            valueLabel.textContent = 'å€¼ (Value)';
            const valueInput = document.createElement('input');
            valueInput.type = 'text';
            valueInput.placeholder = 'ä¾‹å¦‚: "æ–‡æœ¬" æˆ– 123 æˆ– {"key": "value"}';
            const valueHint = document.createElement('div');
            valueHint.className = 'form-hint';
            valueHint.textContent = 'æ”¯æŒå­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼ã€å¯¹è±¡ã€æ•°ç»„ç­‰JSONæ ¼å¼';
            valueRow.appendChild(valueLabel);
            valueRow.appendChild(valueInput);
            valueRow.appendChild(valueHint);
            
            const actions = document.createElement('div');
            actions.className = 'form-actions';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'btn primary';
            confirmBtn.textContent = 'âœ“ æ·»åŠ ';
            confirmBtn.onclick = () => {
                if (!valueInput.value.trim()) {
                    alert('è¯·è¾“å…¥å€¼');
                    return;
                }
                addNode(parentValue, parentPath, keyInput.value, valueInput.value, form);
            };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn ghost';
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.onclick = () => form.remove();
            
            actions.appendChild(confirmBtn);
            actions.appendChild(cancelBtn);
            
            form.appendChild(title);
            form.appendChild(keyRow);
            form.appendChild(valueRow);
            form.appendChild(actions);
            
            const container = node.querySelector('.tree-children');
            if (container) {
                // ç¡®ä¿å®¹å™¨æ˜¯å±•å¼€çš„
                const toggle = node.querySelector('.tree-toggle');
                if (toggle && toggle.getAttribute('data-expanded') === 'false') {
                    toggle.click();
                }
                container.appendChild(form);
                container.classList.remove('hidden');
            } else {
                node.appendChild(form);
            }
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                if (!Array.isArray(parentValue)) {
                    keyInput.focus();
                } else {
                    valueInput.focus();
                }
            }, 100);
        }

        // æ·»åŠ èŠ‚ç‚¹
        function addNode(parentValue, parentPath, key, valueStr, form) {
            try {
                if (!valueStr || valueStr.trim() === '') {
                    alert('è¯·è¾“å…¥å€¼');
                    return;
                }

                let parsedValue;
                try {
                    parsedValue = JSON.parse(valueStr);
                } catch {
                    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œå½“ä½œå­—ç¬¦ä¸²å¤„ç†
                    parsedValue = valueStr;
                }

                if (Array.isArray(parentValue)) {
                    parentValue.push(parsedValue);
                } else if (typeof parentValue === 'object' && parentValue !== null) {
                    if (!key || key.trim() === '') {
                        alert('è¯·è¾“å…¥é”®å');
                        return;
                    }
                    parentValue[key.trim()] = parsedValue;
                }

                form.remove();
                updateJsonFromTree();
                showStatus('èŠ‚ç‚¹å·²æ·»åŠ ');
            } catch (err) {
                showStatus('æ·»åŠ å¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        // ç§»åŠ¨èŠ‚ç‚¹åˆ°ç›®æ ‡ä½ç½®ï¼ˆæ”¯æŒä»»æ„æ‹–åŠ¨ï¼‰
        function moveNodeToTarget(dragData, targetPath, targetValue, targetParentPath, targetParentValue, targetParentPathActual, dropMode) {
            try {
                const fromPath = dragData.path;
                const fromKey = dragData.key;
                const fromValue = dragData.value; // å·²ç»æ˜¯æ·±æ‹·è´
                const fromParentPath = dragData.parentPath;
                
                // è·å–æºèŠ‚ç‚¹çš„çˆ¶å¯¹è±¡
                const fromParentEntry = treeNodeRegistry.get(fromParentPath);
                if (!fromParentEntry) {
                    showStatus('æ‰¾ä¸åˆ°æºèŠ‚ç‚¹', 'error');
                    return;
                }
                
                const fromParentValue = fromParentEntry.value;
                
                // è·å–ç›®æ ‡èŠ‚ç‚¹ä¿¡æ¯
                const targetEntry = treeNodeRegistry.get(targetPath);
                if (!targetEntry) {
                    showStatus('æ‰¾ä¸åˆ°ç›®æ ‡èŠ‚ç‚¹', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦è¯•å›¾å°†èŠ‚ç‚¹æ‹–åˆ°è‡ªå·±å†…éƒ¨
                if (fromPath === targetPath || targetPath.startsWith(fromPath + '/')) {
                    showStatus('ä¸èƒ½å°†èŠ‚ç‚¹æ‹–åˆ°è‡ªå·±å†…éƒ¨', 'error');
                    return;
                }

                // æ£€æŸ¥æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹æ˜¯å¦æ˜¯åŒä¸€ä¸ªï¼ˆé˜²æ­¢é‡å¤æ“ä½œï¼‰
                if (fromPath === targetPath) {
                    return;
                }

                // åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€çˆ¶èŠ‚ç‚¹å†…çš„ç§»åŠ¨
                const isSameParent = fromParentPath === targetParentPathActual;
                
                // æ ¹æ® dropMode å†³å®šæ’å…¥ä½ç½®
                let insertTarget = null;
                let insertKey = null;
                let insertIndex = -1;
                
                if (dropMode === 'inside') {
                    // æ’å…¥åˆ°ç›®æ ‡èŠ‚ç‚¹å†…éƒ¨
                    if (Array.isArray(targetValue)) {
                        insertTarget = targetValue;
                        insertIndex = targetValue.length; // æ’å…¥åˆ°æœ«å°¾
                    } else if (typeof targetValue === 'object' && targetValue !== null) {
                        insertTarget = targetValue;
                        insertKey = fromKey;
                        // å¦‚æœé”®åå†²çªï¼Œä½¿ç”¨æ–°é”®å
                        if (targetValue.hasOwnProperty(insertKey)) {
                            insertKey = fromKey + '_' + Date.now();
                        }
                    } else {
                        showStatus('ä¸èƒ½æ’å…¥åˆ°éå¯¹è±¡/æ•°ç»„èŠ‚ç‚¹å†…éƒ¨', 'error');
                        return;
                    }
                } else {
                    // æ’å…¥åˆ°ç›®æ ‡èŠ‚ç‚¹åé¢ï¼ˆåŒçˆ¶èŠ‚ç‚¹ï¼‰
                    const actualParentValue = targetParentValue || (targetParentPathActual ? treeNodeRegistry.get(targetParentPathActual)?.value : null);
                    
                    if (!actualParentValue) {
                        showStatus('æ‰¾ä¸åˆ°ç›®æ ‡çˆ¶èŠ‚ç‚¹', 'error');
                        return;
                    }

                    if (Array.isArray(actualParentValue)) {
                        // æ•°ç»„ï¼šæ’å…¥åˆ°ç›®æ ‡èŠ‚ç‚¹åé¢
                        const targetIndex = parseInt(targetEntry.key);
                        insertTarget = actualParentValue;
                        insertIndex = targetIndex + 1;
                    } else if (typeof actualParentValue === 'object' && actualParentValue !== null) {
                        // å¯¹è±¡ï¼šæ·»åŠ åˆ°å¯¹è±¡ä¸­
                        insertTarget = actualParentValue;
                        insertKey = fromKey;
                        if (actualParentValue.hasOwnProperty(insertKey)) {
                            insertKey = fromKey + '_' + Date.now();
                        }
                    } else {
                        showStatus('ç›®æ ‡çˆ¶èŠ‚ç‚¹ä¸æ˜¯å¯¹è±¡æˆ–æ•°ç»„', 'error');
                        return;
                    }
                }

                // å¦‚æœæ˜¯åŒä¸€çˆ¶èŠ‚ç‚¹å†…çš„æ•°ç»„ç§»åŠ¨ï¼Œéœ€è¦å…ˆè®¡ç®—æ­£ç¡®çš„æ’å…¥ä½ç½®
                if (isSameParent && Array.isArray(fromParentValue) && Array.isArray(insertTarget) && insertIndex >= 0) {
                    const fromIndex = parseInt(fromKey);
                    // å¦‚æœä»å‰é¢åˆ é™¤ï¼Œæ’å…¥ä½ç½®éœ€è¦è°ƒæ•´
                    if (fromIndex < insertIndex) {
                        insertIndex--;
                    }
                }

                // å…ˆåˆ é™¤æºèŠ‚ç‚¹
                let removed = false;
                if (Array.isArray(fromParentValue)) {
                    const fromIndex = parseInt(fromKey);
                    if (fromIndex >= 0 && fromIndex < fromParentValue.length) {
                        fromParentValue.splice(fromIndex, 1);
                        removed = true;
                    }
                } else if (typeof fromParentValue === 'object' && fromParentValue !== null) {
                    if (fromParentValue.hasOwnProperty(fromKey)) {
                        delete fromParentValue[fromKey];
                        removed = true;
                    }
                }

                if (!removed) {
                    showStatus('åˆ é™¤æºèŠ‚ç‚¹å¤±è´¥', 'error');
                    return;
                }

                // æ’å…¥åˆ°ç›®æ ‡ä½ç½®
                if (insertTarget) {
                    if (Array.isArray(insertTarget)) {
                        insertTarget.splice(insertIndex, 0, fromValue);
                    } else if (typeof insertTarget === 'object' && insertTarget !== null && insertKey) {
                        insertTarget[insertKey] = fromValue;
                    }
                }

                updateJsonFromTree();
                showStatus('èŠ‚ç‚¹å·²ç§»åŠ¨');
            } catch (err) {
                console.error('ç§»åŠ¨èŠ‚ç‚¹å¤±è´¥:', err);
                showStatus('ç§»åŠ¨å¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        // ä»æ ‘å½¢ç»“æ„æ›´æ–° JSON æ•°æ®
        function updateJsonFromTree() {
            if (!currentJsonData) return;
            
            // ä¿å­˜å½“å‰å±•å¼€çš„è·¯å¾„
            const expandedPaths = new Set();
            jsonTree.querySelectorAll('.tree-toggle[data-expanded="true"]').forEach(toggle => {
                const path = toggle.closest('.tree-node')?.querySelector('.tree-label')?.dataset.path;
                if (path) expandedPaths.add(path);
            });
            
            // ä¿å­˜é€‰ä¸­çš„è·¯å¾„
            const savedSelectedNodes = new Set(selectedNodes);
            
            // é‡æ–°æ ¼å¼åŒ– JSON
            const formatted = JSON.stringify(currentJsonData, null, 2);
            jsonOutput.value = formatted;
            
            // é‡æ–°æ¸²æŸ“æ ‘
            renderTree(currentJsonData);
            
            // æ¢å¤å±•å¼€çŠ¶æ€å’Œé€‰ä¸­çŠ¶æ€
            setTimeout(() => {
                expandedPaths.forEach(path => {
                    const entry = treeNodeRegistry.get(path);
                    if (entry && entry.toggle && entry.container) {
                        if (entry.container.dataset.loaded !== 'true') {
                            renderChildrenImmediate(entry.container, entry.value, entry.depth + 1, path, entry.value);
                        }
                        entry.toggle.setAttribute('data-expanded', 'true');
                        entry.toggle.textContent = '-';
                        entry.container.classList.remove('hidden');
                    }
                });
                
                // æ¢å¤é€‰ä¸­çŠ¶æ€
                savedSelectedNodes.forEach(path => {
                    const entry = treeNodeRegistry.get(path);
                    if (entry && entry.node) {
                        entry.node.classList.add('selected');
                        selectedNodes.add(path);
                    }
                });
                
                updateSelectionButtons();
                
                // å¦‚æœæ ¹èŠ‚ç‚¹æœªå±•å¼€ï¼Œè‡ªåŠ¨å±•å¼€
                const rootNode = jsonTree.querySelector('.tree-node');
                const rootToggle = rootNode?.querySelector('.tree-toggle');
                if (rootToggle && rootToggle.getAttribute('data-expanded') === 'false') {
                    rootToggle.click();
                }
            }, 100);
        }

        // åˆ‡æ¢é€‰æ‹©æ¨¡å¼
        function toggleSelectMode() {
            selectMode = !selectMode;
            const btn = document.getElementById('treeSelectModeBtn');

            if (selectMode) {
                btn.textContent = 'âœ“ é€‰æ‹©ä¸­';
                btn.style.background = 'var(--accent-blue)';
                btn.style.color = '#fff';
                // ä¸ºæ‰€æœ‰ç°æœ‰èŠ‚ç‚¹æ·»åŠ é€‰æ‹©åŠŸèƒ½
                jsonTree.querySelectorAll('.tree-label').forEach(label => {
                    // æ ¹èŠ‚ç‚¹ä¸æ·»åŠ é€‰æ‹©åŠŸèƒ½
                    if (label.dataset.path !== 'root') {
                        if (!label.classList.contains('selectable')) {
                            label.classList.add('selectable');
                        }
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
                        if (!label.hasAttribute('data-selection-listener')) {
                            label.addEventListener('click', (e) => {
                                e.stopPropagation();
                                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–æ“ä½œåŒºåŸŸï¼Œä¸è§¦å‘é€‰æ‹©
                                if (e.target.closest('.tree-toggle, .tree-node-actions, .tree-action-btn')) {
                                    return;
                                }
                                if (selectMode) {
                                    const path = label.dataset.path;
                                    toggleNodeSelection(path);
                                }
                            });
                            label.setAttribute('data-selection-listener', 'true');
                        }
                    }
                });
            } else {
                btn.textContent = 'âœ“ é€‰æ‹©æ¨¡å¼';
                btn.style.background = '';
                btn.style.color = '';
                // ç§»é™¤é€‰æ‹©åŠŸèƒ½
                jsonTree.querySelectorAll('.tree-label').forEach(label => {
                    label.classList.remove('selectable');
                    label.removeAttribute('data-selection-listener');
                });
            }
            updateSelectionButtons();
        }

        // æ›´æ–°é€‰æ‹©æŒ‰é’®çŠ¶æ€
        function updateSelectionButtons() {
            const copyBtn = document.getElementById('treeCopySelectedBtn');
            const hasSelection = selectedNodes.size > 0;
            copyBtn.disabled = !hasSelection;
        }

        // è·å–èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„ï¼ˆé€’å½’ï¼Œä»…è·å–å·²åŠ è½½çš„ï¼‰
        function getAllChildPaths(path) {
            const childPaths = [];
            const entry = treeNodeRegistry.get(path);
            if (!entry || !entry.container) return childPaths;
            
            // åªè·å–å·²åŠ è½½çš„å­èŠ‚ç‚¹
            const children = entry.container.querySelectorAll('.tree-node');
            children.forEach(childNode => {
                const childLabel = childNode.querySelector('.tree-label');
                if (childLabel) {
                    const childPath = childLabel.dataset.path;
                    if (childPath) {
                        childPaths.push(childPath);
                        // é€’å½’è·å–å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
                        childPaths.push(...getAllChildPaths(childPath));
                    }
                }
            });
            
            return childPaths;
        }

        // è·å–èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„ï¼ˆåŒ…æ‹¬æœªåŠ è½½çš„ï¼Œé€šè¿‡å€¼é€’å½’ï¼‰
        function getAllChildPathsFromValue(path, value, parentPath) {
            const childPaths = [];
            if (!value || (typeof value !== 'object')) return childPaths;
            
            if (Array.isArray(value)) {
                value.forEach((item, index) => {
                    const childPath = parentPath ? `${parentPath}/${index}` : `${path}/${index}`;
                    childPaths.push(childPath);
                    // é€’å½’è·å–å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
                    if (item && typeof item === 'object') {
                        childPaths.push(...getAllChildPathsFromValue(childPath, item, childPath));
                    }
                });
            } else if (typeof value === 'object' && value !== null) {
                Object.keys(value).forEach(key => {
                    const childPath = parentPath ? `${parentPath}/${key}` : `${path}/${key}`;
                    childPaths.push(childPath);
                    // é€’å½’è·å–å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
                    const childValue = value[key];
                    if (childValue && typeof childValue === 'object') {
                        childPaths.push(...getAllChildPathsFromValue(childPath, childValue, childPath));
                    }
                });
            }
            
            return childPaths;
        }

        // æ›´æ–°èŠ‚ç‚¹çš„é€‰æ‹©çŠ¶æ€UI
        function updateNodeSelectionUI(path, isSelected) {
            const entry = treeNodeRegistry.get(path);
            if (!entry || !entry.node) return;

            entry.node.classList.remove('selected', 'partial-selected');
            if (isSelected) {
                entry.node.classList.add('selected');
            }
        }

        // åˆ‡æ¢èŠ‚ç‚¹é€‰æ‹©çŠ¶æ€ï¼ˆç®€å•ç‹¬ç«‹é€‰æ‹©ï¼‰
        function toggleNodeSelection(path) {
            if (!selectMode) return;

            const entry = treeNodeRegistry.get(path);
            if (!entry) return;

            const wasSelected = selectedNodes.has(path);

            if (wasSelected) {
                // å–æ¶ˆé€‰ä¸­å½“å‰èŠ‚ç‚¹
                selectedNodes.delete(path);
                updateNodeSelectionUI(path, false);
            } else {
                // é€‰ä¸­å½“å‰èŠ‚ç‚¹
                selectedNodes.add(path);
                updateNodeSelectionUI(path, true);
            }

            updateSelectionButtons();
        }

        // å¤åˆ¶å…¨éƒ¨èŠ‚ç‚¹
        function copyAllNodes() {
            if (!currentJsonData) {
                showStatus('æ²¡æœ‰æ•°æ®å¯å¤åˆ¶', 'error');
                return;
            }

            try {
                const jsonToCopy = JSON.stringify(currentJsonData, null, 2);

                navigator.clipboard.writeText(jsonToCopy).then(() => {
                    const btn = document.getElementById('treeCopyAllBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ“ å·²å¤åˆ¶å…¨éƒ¨';
                    btn.style.background = 'var(--accent-green)';
                    btn.style.color = '#fff';
                    showStatus('å·²å¤åˆ¶å…¨éƒ¨JSONæ•°æ®');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.style.color = '';
                    }, 2000);
                }).catch(() => {
                    // å¤‡ç”¨æ–¹æ³•
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = jsonToCopy;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showStatus('å·²å¤åˆ¶å…¨éƒ¨JSONæ•°æ®');
                    } catch (err) {
                        showStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                    }
                });
            } catch (err) {
                console.error('å¤åˆ¶å…¨éƒ¨èŠ‚ç‚¹å¤±è´¥:', err);
                showStatus('å¤åˆ¶å¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        // å¤åˆ¶é€‰ä¸­çš„èŠ‚ç‚¹
        function copySelectedNodes() {
            if (selectedNodes.size === 0) {
                showStatus('è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„èŠ‚ç‚¹', 'error');
                return;
            }

            const selectedPathsArray = Array.from(selectedNodes);
            console.log('é€‰ä¸­çš„èŠ‚ç‚¹è·¯å¾„:', selectedPathsArray);

            let jsonToCopy;

            try {
                const result = {};

                // æ‰¾å‡ºæ‰€æœ‰çˆ¶èŠ‚ç‚¹
                const parentNodes = new Map();
                selectedPathsArray.forEach(path => {
                    const entry = treeNodeRegistry.get(path);
                    if (!entry) return;

                    const isExpandable = entry.value && (Array.isArray(entry.value) || (typeof entry.value === 'object' && entry.value !== null));
                    if (isExpandable) {
                        parentNodes.set(path, entry);
                    }
                });

                console.log('è¯†åˆ«çš„çˆ¶èŠ‚ç‚¹:', Array.from(parentNodes.keys()));

                // å¤„ç†æ¯ä¸ªé€‰ä¸­çš„èŠ‚ç‚¹
                selectedPathsArray.forEach(path => {
                    const entry = treeNodeRegistry.get(path);
                    if (!entry) return;

                    const key = entry.key;
                    const value = entry.value;

                    // æ£€æŸ¥æ˜¯å¦æœ‰çˆ¶èŠ‚ç‚¹ä¹Ÿè¢«é€‰ä¸­
                    let hasParentSelected = false;
                    let parentPath = null;
                    for (const pPath of parentNodes.keys()) {
                        if (path.startsWith(pPath + '/') && path !== pPath) {
                            hasParentSelected = true;
                            parentPath = pPath;
                            break;
                        }
                    }

                    console.log(`å¤„ç†èŠ‚ç‚¹ ${path}: çˆ¶èŠ‚ç‚¹é€‰ä¸­=${hasParentSelected}, æ˜¯çˆ¶èŠ‚ç‚¹=${parentNodes.has(path)}`);

                    if (!hasParentSelected) {
                        // è¿™ä¸ªèŠ‚ç‚¹æ²¡æœ‰çˆ¶èŠ‚ç‚¹è¢«é€‰ä¸­
                        if (parentNodes.has(path)) {
                            // è¿™ä¸ªèŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å­èŠ‚ç‚¹è¢«é€‰ä¸­
                            const selectedChildren = selectedPathsArray.filter(childPath =>
                                childPath.startsWith(path + '/') && childPath !== path
                            );

                            console.log(`çˆ¶èŠ‚ç‚¹ ${path} çš„é€‰ä¸­å­èŠ‚ç‚¹:`, selectedChildren);

                            if (selectedChildren.length > 0) {
                                // æœ‰å­èŠ‚ç‚¹è¢«é€‰ä¸­ï¼Œæ„å»ºåŒ…å«é€‰ä¸­å­èŠ‚ç‚¹çš„çˆ¶ç»“æ„
                                if (Array.isArray(value)) {
                                    result[key] = [];
                                    selectedChildren.forEach(childPath => {
                                        const childEntry = treeNodeRegistry.get(childPath);
                                        if (childEntry) {
                                            const index = parseInt(childPath.split('/').pop());
                                            result[key][index] = childEntry.value;
                                            console.log(`æ·»åŠ æ•°ç»„å…ƒç´  [${index}] = ${childEntry.value}`);
                                        }
                                    });
                                } else {
                                    result[key] = {};
                                    selectedChildren.forEach(childPath => {
                                        const childEntry = treeNodeRegistry.get(childPath);
                                        if (childEntry) {
                                            const childKey = childPath.split('/').pop();
                                            result[key][childKey] = childEntry.value;
                                            console.log(`æ·»åŠ å¯¹è±¡å±æ€§ ${childKey} = ${childEntry.value}`);
                                        }
                                    });
                                }
                            } else {
                                // æ²¡æœ‰å­èŠ‚ç‚¹è¢«é€‰ä¸­ï¼Œå¤åˆ¶å®Œæ•´çˆ¶èŠ‚ç‚¹å€¼
                                result[key] = value;
                                console.log(`å¤åˆ¶å®Œæ•´çˆ¶èŠ‚ç‚¹ ${path}:`, value);
                            }
                        } else {
                            // è¿™ä¸ªèŠ‚ç‚¹ä¸æ˜¯çˆ¶èŠ‚ç‚¹ï¼Œç›´æ¥æ·»åŠ å…¶å€¼
                            result[key] = value;
                            console.log(`æ·»åŠ ç‹¬ç«‹èŠ‚ç‚¹ ${path}:`, value);
                        }
                    } else {
                        console.log(`è·³è¿‡å­èŠ‚ç‚¹ ${path}ï¼Œå› ä¸ºçˆ¶èŠ‚ç‚¹ ${parentPath} å·²è¢«é€‰ä¸­`);
                    }
                    // å¦‚æœæœ‰çˆ¶èŠ‚ç‚¹è¢«é€‰ä¸­ï¼Œå­èŠ‚ç‚¹å·²åœ¨å¤„ç†çˆ¶èŠ‚ç‚¹æ—¶å¤„ç†è¿‡äº†
                });

                console.log('æ„å»ºçš„resultå¯¹è±¡:', result);

                // æ¸…ç†æ•°ç»„ç»“æœ
                Object.keys(result).forEach(key => {
                    if (Array.isArray(result[key])) {
                        const original = result[key];
                        result[key] = result[key].filter(item => item !== undefined);
                        console.log(`æ¸…ç†æ•°ç»„ ${key}: ${original} -> ${result[key]}`);
                    }
                });

                jsonToCopy = JSON.stringify(result, null, 2);
                console.log('æœ€ç»ˆJSON:', jsonToCopy);

                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(jsonToCopy).then(() => {
                    const btn = document.getElementById('treeCopySelectedBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ“ å·²å¤åˆ¶';
                    btn.style.background = 'var(--accent-green)';
                    btn.style.color = '#fff';
                    showStatus(`å·²å¤åˆ¶é€‰ä¸­èŠ‚ç‚¹çš„æ•°æ®`);
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.style.color = '';
                    }, 2000);
                }).catch(() => {
                    // å¤‡ç”¨æ–¹æ³•
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = jsonToCopy;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showStatus(`å·²å¤åˆ¶é€‰ä¸­èŠ‚ç‚¹çš„æ•°æ®`);
                    } catch (err) {
                        showStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                    }
                });
            } catch (err) {
                console.error('å¤åˆ¶é€‰ä¸­èŠ‚ç‚¹å¤±è´¥:', err);
                showStatus('å¤åˆ¶å¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        function searchTree() {
            const rawKeyword = treeSearchInput.value.trim();
            const keyword = rawKeyword.toLowerCase();
            jsonTree.querySelectorAll('.tree-search-match').forEach(el => el.classList.remove('tree-search-match'));
            treeSearchMatches = [];
            treeSearchIndex = -1;

            if (!currentJsonData) {
                treeSearchResult.textContent = 'è¯·å…ˆè§£æ JSON';
                return;
            }

            if (!keyword) {
                treeSearchResult.textContent = 'è¯·è¾“å…¥å…³é”®å­—';
                return;
            }

            const matchPaths = new Set();
            collectMatches(currentJsonData, 'root', keyword, matchPaths);

            matchPaths.forEach((path) => {
                const label = ensureNodeVisible(path);
                if (label) {
                    label.classList.add('tree-search-match');
                    treeSearchMatches.push({ path, label });
                }
            });

            if (treeSearchMatches.length === 0) {
                treeSearchResult.textContent = `æœªæ‰¾åˆ° "${rawKeyword}"`;
                return;
            }

            treeSearchIndex = 0;
            scrollToTreeMatch();
            updateTreeSearchInfo();
        }

        function collectMatches(value, path, keyword, resultSet) {
            if (value === null || typeof value !== 'object') {
                if (String(value).toLowerCase().includes(keyword)) {
                    resultSet.add(path);
                }
                return;
            }

            if (Array.isArray(value)) {
                value.forEach((item, index) => {
                    const childPath = buildChildPath(path, index);
                    if (String(index).includes(keyword)) {
                        resultSet.add(childPath);
                    }
                    collectMatches(item, childPath, keyword, resultSet);
                });
            } else {
                Object.entries(value).forEach(([key, val]) => {
                    const childPath = buildChildPath(path, key);
                    if (key.toLowerCase().includes(keyword)) {
                        resultSet.add(childPath);
                    }
                    collectMatches(val, childPath, keyword, resultSet);
                });
            }
        }

        function ensureNodeVisible(path) {
            const segments = path.split('/');
            if (segments[0] !== 'root') return null;
            let currentPath = segments[0];

            for (let i = 1; i < segments.length; i++) {
                const parentPath = currentPath;
                const parentEntry = treeNodeRegistry.get(parentPath);
                if (parentEntry && parentEntry.toggle) {
                    if (parentEntry.container && parentEntry.container.dataset.loaded !== 'true') {
                        renderChildrenImmediate(parentEntry.container, parentEntry.value, parentEntry.depth + 1, parentPath, parentEntry.value);
                    }
                    if (parentEntry.toggle.getAttribute('data-expanded') === 'false') {
                        parentEntry.toggle.setAttribute('data-expanded', 'true');
                        parentEntry.toggle.textContent = '-';
                        parentEntry.container.classList.remove('hidden');
                    }
                }

                currentPath = `${currentPath}/${segments[i]}`;
                let entry = treeNodeRegistry.get(currentPath);

                if (!entry && parentEntry && parentEntry.container) {
                    renderChildrenImmediate(parentEntry.container, parentEntry.value, parentEntry.depth + 1, parentPath, parentEntry.value);
                    entry = treeNodeRegistry.get(currentPath);
                }

                if (!entry) {
                    return null;
                }
            }

            const targetEntry = treeNodeRegistry.get(path);
            return targetEntry ? targetEntry.label : null;
        }

        function navigateTreeMatch(direction) {
            if (treeSearchMatches.length === 0) return;
            treeSearchIndex = (treeSearchIndex + direction + treeSearchMatches.length) % treeSearchMatches.length;
            scrollToTreeMatch();
            updateTreeSearchInfo();
        }

        function scrollToTreeMatch() {
            const match = treeSearchMatches[treeSearchIndex];
            if (!match) return;
            ensureNodeVisible(match.path);
            match.label.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function updateTreeSearchInfo() {
            const keyword = treeSearchInput.value.trim();
            treeSearchResult.textContent = `æ‰¾åˆ° ${treeSearchMatches.length} é¡¹åŒ¹é…ï¼ˆ${treeSearchIndex + 1}/${treeSearchMatches.length}ï¼‰ï¼š${keyword}`;
        }

        function toggleTreeFullscreen() {
            if (!treePanel || !treeFullscreenBtn) return;
            const entering = !treePanel.classList.contains('fullscreen');
            if (entering) {
                treePanel.classList.add('fullscreen');
                document.body.classList.add('tree-fullscreen-active');
                treeFullscreenBtn.textContent = 'â›¶ é€€å‡º';
            } else {
                treePanel.classList.remove('fullscreen');
                document.body.classList.remove('tree-fullscreen-active');
                treeFullscreenBtn.textContent = 'â›¶ å…¨å±';
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (treePanel && treePanel.classList.contains('fullscreen')) {
                    treePanel.classList.remove('fullscreen');
                    document.body.classList.remove('tree-fullscreen-active');
                    if (treeFullscreenBtn) {
                        treeFullscreenBtn.textContent = 'â›¶ å…¨å±';
                    }
                }
                const helpModal = document.getElementById('helpModal');
                const shareModal = document.getElementById('shareModal');
                if (helpModal && helpModal.classList.contains('show')) {
                    toggleHelp();
                }
                if (shareModal && shareModal.classList.contains('show')) {
                    toggleShare();
                }
            }
        });

        // ==================== å†å²è®°å½•åŠŸèƒ½ ====================
        const JSON_HISTORY_KEY = 'jsonToolsHistory';
        const MAX_HISTORY = 20;

        function toggleHistory() {
            const drawer = document.getElementById('historyDrawer');
            const overlay = document.getElementById('historyOverlay');
            const isOpening = !drawer.classList.contains('show');
            
            drawer.classList.toggle('show');
            overlay.classList.toggle('show');
            
            if (isOpening) {
                loadHistoryList();
            }
        }

        function saveToHistory(jsonText) {
            if (!jsonText) return;
            
            const history = getHistory();
            const newRecord = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                jsonText: jsonText,
                preview: jsonText.substring(0, 100),
                length: jsonText.length
            };
            
            history.unshift(newRecord);
            if (history.length > MAX_HISTORY) {
                history.splice(MAX_HISTORY);
            }
            
            try {
                localStorage.setItem(JSON_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
                if (e.name === 'QuotaExceededError') {
                    const reduced = history.slice(0, Math.floor(MAX_HISTORY / 2));
                    localStorage.setItem(JSON_HISTORY_KEY, JSON.stringify(reduced));
                }
            }
        }

        function getHistory() {
            try {
                const data = localStorage.getItem(JSON_HISTORY_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('è¯»å–å†å²è®°å½•å¤±è´¥:', e);
                return [];
            }
        }

        function loadHistoryList() {
            const history = getHistory();
            const listContainer = document.getElementById('historyList');
            
            if (history.length === 0) {
                listContainer.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon">ğŸ“œ</div>
                        <div class="history-empty-text">
                            æš‚æ— å†å²è®°å½•<br>
                            æ ¼å¼åŒ–JSONåä¼šè‡ªåŠ¨ä¿å­˜
                        </div>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = history.map((record, index) => {
                const time = formatTime(record.timestamp);
                const number = index + 1;
                return `
                    <div class="history-item" onclick="loadHistory(${record.id})">
                        <div class="history-item-header">
                            <div class="history-item-number">#${number}</div>
                            <div class="history-item-time">${time}</div>
                            <button class="history-item-delete" onclick="event.stopPropagation(); deleteHistory(${record.id})" title="åˆ é™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                        <div class="history-item-preview">
                            <div class="history-item-label">JSONå†…å®¹</div>
                            <div class="history-item-text" title="${escapeHtml(record.preview)}">${escapeHtml(record.preview)}</div>
                        </div>
                        <div class="history-item-meta">
                            <span>${formatSize(record.length)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadHistory(id) {
            const history = getHistory();
            const record = history.find(r => r.id === id);
            
            if (!record) return;
            
            jsonInput.value = record.jsonText;
            updateStats();
            toggleHistory();
            
            setTimeout(() => {
                showStatus('âœ… å·²åŠ è½½å†å²è®°å½•');
            }, 100);
        }

        function deleteHistory(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            
            const history = getHistory();
            const filtered = history.filter(r => r.id !== id);
            localStorage.setItem(JSON_HISTORY_KEY, JSON.stringify(filtered));
            
            loadHistoryList();
        }

        function clearHistory() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            localStorage.removeItem(JSON_HISTORY_KEY);
            loadHistoryList();
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today - 86400000);
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const hour = date.getHours().toString().padStart(2, '0');
            const minute = date.getMinutes().toString().padStart(2, '0');
            const second = date.getSeconds().toString().padStart(2, '0');
            const timeStr = `${hour}:${minute}:${second}`;
            
            if (dateOnly.getTime() === today.getTime()) {
                return `ä»Šå¤© ${timeStr}`;
            } else if (dateOnly.getTime() === yesterday.getTime()) {
                return `æ˜¨å¤© ${timeStr}`;
            } else {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}æœˆ${day}æ—¥ ${timeStr}`;
            }
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + 'å­—ç¬¦';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }


        // ==================== åˆ†äº«åŠŸèƒ½ ====================
        function toggleShare() {
            const modal = document.getElementById('shareModal');
            const isOpening = !modal.classList.contains('show');
            modal.classList.toggle('show');
            
            if (isOpening) {
                document.getElementById('wechatShareContent').style.display = 'none';
                document.getElementById('shareUrlSection').style.display = 'flex';
                const url = window.location.href;
                document.getElementById('shareUrl').value = url;
                document.getElementById('shareUrlWechat').value = url;
            }
        }

        function shareToWeChat() {
            document.getElementById('wechatShareContent').style.display = 'block';
            document.getElementById('shareUrlSection').style.display = 'none';
        }

        function copyShareText() {
            const text = document.getElementById('shareText').textContent;
            const btn = event.target;
            const originalText = btn.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    btn.textContent = 'å·²å¤åˆ¶ï¼';
                    btn.style.background = 'var(--accent-green)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(() => {
                    fallbackCopyText(text, btn, originalText);
                });
            } else {
                fallbackCopyText(text, btn, originalText);
            }
        }

        function fallbackCopyText(text, btn, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    btn.textContent = 'å·²å¤åˆ¶ï¼';
                    btn.style.background = 'var(--accent-green)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰æ–‡æ¡ˆæ‰‹åŠ¨å¤åˆ¶');
                }
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰æ–‡æ¡ˆæ‰‹åŠ¨å¤åˆ¶');
            }
            
            document.body.removeChild(textArea);
        }

        function copyShareUrl() {
            const input = document.getElementById('shareUrl');
            const btn = event.target;
            const originalText = btn.textContent;
            
            input.select();
            input.setSelectionRange(0, 99999);
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(input.value).then(() => {
                    btn.textContent = 'å·²å¤åˆ¶ï¼';
                    btn.style.background = 'var(--accent-green)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(() => {
                    tryExecCommandCopy(input, btn, originalText);
                });
            } else {
                tryExecCommandCopy(input, btn, originalText);
            }
        }

        function tryExecCommandCopy(input, btn, originalText) {
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    btn.textContent = 'å·²å¤åˆ¶ï¼';
                    btn.style.background = 'var(--accent-green)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰é“¾æ¥æ‰‹åŠ¨å¤åˆ¶');
                }
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰é“¾æ¥æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        function copyWechatUrl() {
            const input = document.getElementById('shareUrlWechat');
            const btn = event.target;
            const originalText = btn.textContent;
            
            input.select();
            input.setSelectionRange(0, 99999);
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(input.value).then(() => {
                    btn.textContent = 'å·²å¤åˆ¶ï¼';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(() => {
                    copyWithExecCommand(input, btn, originalText);
                });
            } else {
                copyWithExecCommand(input, btn, originalText);
            }
        }

        function copyWithExecCommand(input, btn, originalText) {
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    btn.textContent = 'å·²å¤åˆ¶ï¼';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰é“¾æ¥æ‰‹åŠ¨å¤åˆ¶');
                }
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰é“¾æ¥æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        function shareToWeibo() {
            const text = 'å‘ç°ä¸€ä¸ªè¶…å¥½ç”¨çš„JSONæ ¼å¼åŒ–å·¥å…·ï¼âœ¨ æ”¯æŒæ ¼å¼åŒ–ã€å‹ç¼©ã€è½¬ä¹‰ã€æ ‘ç»“æ„æŸ¥çœ‹ï¼Œå®Œå…¨å…è´¹ä½¿ç”¨ï¼å¼€å‘è€…å¿…å¤‡ç¥å™¨ ğŸš€';
            const url = encodeURIComponent(window.location.href);
            const shareUrl = `https://service.weibo.com/share/share.php?url=${url}&title=${encodeURIComponent(text)}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
        }

        // ==================== å¸®åŠ©åŠŸèƒ½ ====================
        function toggleHelp() {
            const modal = document.getElementById('helpModal');
            modal.classList.toggle('show');
        }
    </script>
</body>
</html>
